name: CI ubuntu Build

on:
  push:
    branches:
      - '*'
    tags:
      - '**'
      
  pull_request:
    paths-ignore:
      - "**.md"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-20.04]
 
    runs-on: ${{ matrix.platform }}
    name: ${{ matrix.platform }}
        
    steps:
      - name: Clone repo
        uses: actions/checkout@v2.3.4
        with:
          submodules: recursive
 
      - name: Install Qt from package manager
        run: |
          sudo apt update
          sudo apt install qt5-default qt5-qmake qt5-qmake-bin libqt5core5a libqt5gui5 libqt5concurrent5 libqt5qml5 libqt5quick5 qml-module-qtquick2 qml-module-qtquick-controls2 qml-module-qtquick-layouts qml-module-qtquick-dialogs qml-module-qtquick-extras qml-module-qtquick-templates2 libqt5quickcontrols2-5 libqt5quicktemplates2-5 libqt5quickwidgets5

      - name: Install required packages
        run: |
          sudo apt install cmake make extra-cmake-modules libkf5syntaxhighlighting-dev libkf5syntaxhighlighting-data libkf5syntaxhighlighting-tools rpm
          
      - name: Install QtAseman
        run: |
          sudo add-apt-repository ppa:aseman/qt-modules
          sudo apt install qt5aseman
          
      - name: Build with CMake
        run: |
          mkdir build-cmake
          cd build-cmake
          cmake .. ${{ matrix.additional_arguments }}  ${{ matrix.cmake_params }} -DGITKLIENT_BUILD_DIR=build-cmake
          make -j 4
          VAR=`cat version`
          echo "version=${VAR}" >> $GITHUB_ENV
          
      - name: Run tests
        run: |
          cd build-cmake
          make test
              
      - name: Build deb package
        run: |
          cd build-cmake
          sudo cpack -G DEB
          
      - name: Build rpm package
        run: |
          cd build-cmake
          sudo cpack -G RPM
  
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag_name="${GITHUB_REF##*/}"
          gh release create $tag_name --generate-notes
          gh release upload $tag_name ./build-cmake/tricks.deb#tricks_${tag_name}_amd64.deb
          gh release upload $tag_name ./build-cmake/tricks.rpm#tricks-${tag_name}-Linux.rpm
